<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Ecosistema de Conservaci√≥n - Monitoreo en Tiempo Real</title>
    <meta name="description" content="Sistema de monitoreo AR/VR para especies en peligro">
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/fernandojsg/aframe-orbit-controls-component@master/dist/aframe-orbit-controls-component.min.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        overflow: hidden;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
    </style>
  </head>
  <body>
    <a-scene 
      background="color: #87CEEB" 
      vr-mode-ui="enabled: false"
      fog="type: exponential; color: #E0F2F7; density: 0.01"
      shadow="type: pcf">
      
      <a-sky 
        id="sky-gradient"
        color="#87CEEB"
        material="shader: flat"
        rotation="0 -130 0">
      </a-sky>
      
      <a-entity 
        geometry="primitive: sphere; radius: 99; segmentsWidth: 64; segmentsHeight: 15"
        material="shader: flat; color: #4A90E2; opacity: 0.4"
        rotation="0 -130 0"
        scale="1 0.6 1">
      </a-entity>
      
      <a-sphere 
        position="8 12 -20" 
        radius="2" 
        color="#FFD700"
        material="emissive: #FFD700; emissiveIntensity: 0.8">
      </a-sphere>
      
      <a-ring 
        position="8 12 -20" 
        radius-inner="2.5" 
        radius-outer="4" 
        color="#FFE082"
        opacity="0.3"
        rotation="90 0 0">
      </a-ring>
      
      <a-light type="ambient" color="#ffffff" intensity="0.5"></a-light>
      
      <a-light 
        type="directional" 
        position="5 10 5" 
        intensity="1.2" 
        cast-shadow="true"
        shadow-map-width="2048"
        shadow-map-height="2048"
        shadow-camera-left="-20"
        shadow-camera-right="20"
        shadow-camera-top="20"
        shadow-camera-bottom="-20"
        shadow-bias="-0.0001">
      </a-light>
      
      <a-light 
        type="directional" 
        position="-3 8 -3" 
        intensity="0.3" 
        color="#FFE5B4">
      </a-light>
      
      <a-plane 
        id="suelo"
        position="0 -0.5 0" 
        rotation="-90 0 0" 
        width="50" 
        height="50" 
        color="#7CB342"
        shadow="receive: true"
        material="roughness: 0.8; metalness: 0.1">
      </a-plane>
      
      <a-plane position="-5 -0.49 5" rotation="-90 0 0" width="8" height="8" color="#66BB6A" opacity="0.6"></a-plane>
      <a-plane position="6 -0.49 -4" rotation="-90 0 0" width="6" height="6" color="#66BB6A" opacity="0.5"></a-plane>
      <a-plane position="-8 -0.49 -6" rotation="-90 0 0" width="5" height="5" color="#66BB6A" opacity="0.4"></a-plane>
      
      <a-entity id="monta√±as">
        <a-cone position="-15 -0.5 -20" radius-bottom="8" radius-top="0" height="12" color="#6B8E23" shadow="cast: true" material="roughness: 0.9"></a-cone>
        <a-cone position="-12 -0.5 -22" radius-bottom="6" radius-top="0" height="10" color="#556B2F" shadow="cast: true" material="roughness: 0.9"></a-cone>
        <a-cone position="-8 -0.5 -18" radius-bottom="7" radius-top="0" height="11" color="#6B8E23" shadow="cast: true" material="roughness: 0.9"></a-cone>
        <a-cone position="8 -0.5 -19" radius-bottom="9" radius-top="0" height="13" color="#556B2F" shadow="cast: true" material="roughness: 0.9"></a-cone>
        <a-cone position="14 -0.5 -21" radius-bottom="7" radius-top="0" height="10" color="#6B8E23" shadow="cast: true" material="roughness: 0.9"></a-cone>
        <a-cone position="17 -0.5 -23" radius-bottom="5" radius-top="0" height="9" color="#556B2F" shadow="cast: true" material="roughness: 0.9"></a-cone>
      </a-entity>
      
      <a-entity id="nubes">
        <a-entity position="-10 8 -15" animation="property: position; to: -8 8 -15; loop: true; dur: 15000; easing: easeInOutSine">
          <a-sphere radius="1.5" color="#FFFFFF" opacity="0.8" position="-0.5 0 0"></a-sphere>
          <a-sphere radius="1.2" color="#FFFFFF" opacity="0.8" position="0.5 0.3 0"></a-sphere>
          <a-sphere radius="1" color="#FFFFFF" opacity="0.8" position="0.8 0 0.2"></a-sphere>
          <a-sphere radius="1.3" color="#FFFFFF" opacity="0.8" position="0 0.2 -0.3"></a-sphere>
        </a-entity>
        <a-entity position="12 7 -18" animation="property: position; to: 14 7 -18; loop: true; dur: 18000; easing: easeInOutSine">
          <a-sphere radius="1.4" color="#FFFFFF" opacity="0.75" position="-0.4 0 0"></a-sphere>
          <a-sphere radius="1.1" color="#FFFFFF" opacity="0.75" position="0.6 0.2 0"></a-sphere>
          <a-sphere radius="0.9" color="#FFFFFF" opacity="0.75" position="0.7 0 -0.2"></a-sphere>
          <a-sphere radius="1.2" color="#FFFFFF" opacity="0.75" position="0.1 0.3 0.3"></a-sphere>
        </a-entity>
        <a-entity position="0 9 -12" animation="property: position; to: 2 9 -12; loop: true; dur: 20000; easing: easeInOutSine">
          <a-sphere radius="1.3" color="#FFFFFF" opacity="0.7" position="-0.3 0 0"></a-sphere>
          <a-sphere radius="1" color="#FFFFFF" opacity="0.7" position="0.5 0.25 0"></a-sphere>
          <a-sphere radius="0.8" color="#FFFFFF" opacity="0.7" position="0.6 0 -0.15"></a-sphere>
        </a-entity>
        <a-entity position="-15 6 -20" animation="property: position; to: -13 6 -20; loop: true; dur: 16000; easing: easeInOutSine">
          <a-sphere radius="1.2" color="#FFFFFF" opacity="0.8" position="-0.5 0 0"></a-sphere>
          <a-sphere radius="1" color="#FFFFFF" opacity="0.8" position="0.4 0.2 0"></a-sphere>
          <a-sphere radius="0.9" color="#FFFFFF" opacity="0.8" position="0.5 0 0.2"></a-sphere>
        </a-entity>
      </a-entity>
      
      <a-entity id="decoraciones">
        <a-box position="-6 -0.3 3" width="1.5" height="0.8" depth="1.2" color="#5D4037" rotation="0 25 5" shadow="cast: true" material="roughness: 0.9; metalness: 0.1"></a-box>
        <a-box position="7 -0.3 4" width="1.2" height="0.6" depth="1" color="#4E342E" rotation="0 -15 8" shadow="cast: true" material="roughness: 0.9; metalness: 0.1"></a-box>
        <a-box position="-8 -0.3 -2" width="1" height="0.5" depth="0.8" color="#5D4037" rotation="0 45 -5" shadow="cast: true" material="roughness: 0.9; metalness: 0.1"></a-box>
        <a-box position="5 -0.3 -3" width="1.3" height="0.7" depth="1.1" color="#4E342E" rotation="0 -30 10" shadow="cast: true" material="roughness: 0.9; metalness: 0.1"></a-box>
        <a-cylinder position="-10 -0.2 2" radius="0.3" height="3" color="#8B4513" rotation="0 0 15" shadow="cast: true" material="roughness: 0.8"></a-cylinder>
        <a-cylinder position="9 -0.2 -1" radius="0.25" height="2.5" color="#8B4513" rotation="0 0 -20" shadow="cast: true" material="roughness: 0.8"></a-cylinder>
      </a-entity>
      
      <a-entity id="particulas">
        <a-entity position="-5 1 3" animation="property: position; to: -4.8 1.5 3.2; loop: true; dur: 3000; easing: easeInOutSine">
          <a-sphere radius="0.05" color="#D7CCC8" opacity="0.4"></a-sphere>
        </a-entity>
        <a-entity position="6 0.8 -2" animation="property: position; to: 6.2 1.3 -1.8; loop: true; dur: 3500; easing: easeInOutSine">
          <a-sphere radius="0.04" color="#D7CCC8" opacity="0.3"></a-sphere>
        </a-entity>
        <a-entity position="-3 1.2 5" animation="property: position; to: -2.9 1.6 5.1; loop: true; dur: 2800; easing: easeInOutSine">
          <a-sphere radius="0.05" color="#D7CCC8" opacity="0.4"></a-sphere>
        </a-entity>
        <a-entity position="4 2 -1" animation="property: position; to: 4.3 2.5 -0.7; loop: true; dur: 4000; easing: easeInOutSine">
          <a-box width="0.1" height="0.1" depth="0.02" color="#8BC34A" opacity="0.6" rotation="45 0 45"></a-box>
        </a-entity>
        <a-entity position="-7 1.5 4" animation="property: position; to: -6.8 2 4.2; loop: true; dur: 4500; easing: easeInOutSine">
          <a-box width="0.12" height="0.12" depth="0.02" color="#9CCC65" opacity="0.5" rotation="30 0 60"></a-box>
        </a-entity>
        <a-entity position="8 1.8 -3" animation="property: position; to: 8.2 2.3 -2.8; loop: true; dur: 3800; easing: easeInOutSine">
          <a-box width="0.1" height="0.1" depth="0.02" color="#8BC34A" opacity="0.6" rotation="60 0 30"></a-box>
        </a-entity>
        <a-entity position="-2 1.3 6" animation="property: position; to: -1.9 1.8 6.1; loop: true; dur: 4200; easing: easeInOutSine">
          <a-box width="0.11" height="0.11" depth="0.02" color="#9CCC65" opacity="0.5" rotation="45 0 45"></a-box>
        </a-entity>
      </a-entity>
      
      <a-entity 
        id="model-walk" 
        gltf-model="Walk in the Woods.glb" 
        position="0 -0.5 -4" 
        scale="6 6 6" 
        rotation="0 180 0"
        animation="property: rotation; to: 0 540 0; loop: true; dur: 20000; easing: linear">
        <a-light id="bosqueLight" type="point" color="#ffffff" intensity="1" distance="10" position="0 2 0"></a-light>
      </a-entity>
      
      <a-entity 
        id="animal"
        gltf-model="Wolf.glb" 
        position="5 0 -3" 
        scale="0.5 0.5 0.5" 
        rotation="0 -90 0"
        material="color: #8B7355; metalness: 0.3; roughness: 0.7"
        animation__rotate="property: rotation; to: 0 -450 0; loop: true; dur: 15000; easing: linear"
        animation__bounce="property: position; to: 5 0.2 -3; loop: true; dur: 2000; easing: easeInOutSine; dir: alternate">
      </a-entity>
      
      <a-ring 
        id="alertaRing"
        position="5 0 -3" 
        radius-inner="1.5" 
        radius-outer="2.5" 
        color="#ff0000"
        opacity="0"
        rotation="90 0 0"
        visible="false">
      </a-ring>
      
      <a-light 
        id="alertaLight"
        type="point" 
        position="5 1 -3" 
        color="#ff0000" 
        intensity="0"
        distance="5">
      </a-light>
      
      <a-sound id="alertaSound" src="#alertaAudio" autoplay="false" loop="false" volume="0.5"></a-sound>
      <audio id="alertaAudio" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGWi77+efTRAMUKfj8LZjHAY4kdfyzHksBSR3x/DdkEAKFF606euoVRQKRp/g8r5sIQUrgc7y2Yk2CBlou+/nn00QDFCn4/C2YxwGOJHX8sx5LAUkd8fw3ZBAC" type="audio/wav">
      </audio>
      
      <a-entity id="panelSensoresContainer" position="-5 3.5 -1.8" rotation="0 0 0">
        <a-plane id="panelSensores" width="3.5" height="3.2" color="#0a0a0a" opacity="0.95"></a-plane>
        <a-plane width="3.4" height="0.06" color="#4ecdc4" opacity="1" position="0 1.4 0.01"></a-plane>
        <a-text value="üìä SENSORES" width="4" position="0 1.25 0.02" color="#4ecdc4" align="center" font="roboto" shader="msdf"></a-text>
        <a-text id="latidoText" value="üíì Latido: -- bpm" width="3.5" position="-1.3 0.75 0.02" color="#ff6b6b" align="left" font="roboto" shader="msdf"></a-text>
        <a-box id="latidoBar" width="2.3" height="0.12" depth="0.1" color="#ff6b6b" position="0.05 0.55 0.02" scale="0.5 1 1"></a-box>
        <a-text id="movimientoText" value="üèÉ Movimiento: --" width="3.5" position="-1.3 0.25 0.02" color="#4ecdc4" align="left" font="roboto" shader="msdf"></a-text>
        <a-box id="movimientoBar" width="2.3" height="0.12" depth="0.1" color="#4ecdc4" position="0.05 0.05 0.02" scale="0.5 1 1"></a-box>
        <a-text id="humedadText" value="üíß Humedad: --%" width="3.5" position="-1.3 -0.25 0.02" color="#45b7d1" align="left" font="roboto" shader="msdf"></a-text>
        <a-box id="humedadBar" width="2.3" height="0.12" depth="0.1" color="#45b7d1" position="0.05 -0.45 0.02" scale="0.5 1 1"></a-box>
        <a-text id="depredadorText" value="ü¶Å Depredador: No" width="3.5" position="-1.3 -0.75 0.02" color="#ff9800" align="left" font="roboto" shader="msdf"></a-text>
        <a-box id="depredadorBar" width="2.3" height="0.12" depth="0.1" color="#ff9800" position="0.05 -0.95 0.02" scale="0 1 1"></a-box>
        <a-text id="riesgoText" value="‚ö†Ô∏è Riesgo: Normal" width="3.5" position="-1.3 -1.25 0.02" color="#95e1d3" align="left" font="roboto" shader="msdf"></a-text>
        <a-box id="riesgoBar" width="2.3" height="0.12" depth="0.1" color="#95e1d3" position="0.05 -1.45 0.02" scale="0 1 1"></a-box>
      </a-entity>
      
      <a-entity id="panelTemperaturaContainer" position="0 3.5 -1.8">
        <a-plane id="panelTemperatura" width="4" height="1.2" color="#0a0a0a" opacity="0.95"></a-plane>
        <a-plane width="3.9" height="0.06" color="#00ff88" opacity="1" position="0 0.55 0.01"></a-plane>
        <a-text id="sensorText" value="üå°Ô∏è Temperatura: --¬∞C" width="4.5" position="0 0.1 0.02" color="#00ff88" align="center" font="roboto" shader="msdf"></a-text>
        <a-box id="tempBar" width="3" height="0.18" depth="0.1" color="#00ff88" position="0 -0.35 0.02" scale="0.5 1 1"></a-box>
      </a-entity>
      
      <a-entity id="panelAlertasContainer" position="5 3.5 -1.8" rotation="0 0 0" visible="false">
        <a-plane id="panelAlertas" width="3.5" height="2" color="#8B0000" opacity="0" visible="false"></a-plane>
        <a-plane width="3.4" height="0.06" color="#ff0000" opacity="1" position="0 0.95 0.01"></a-plane>
        <a-text id="alertaText" value="üö® ALERTA DE RIESGO" width="4" position="0 0.75 0.02" color="#ff0000" align="center" font="roboto" shader="msdf" visible="false"></a-text>
        <a-text value="‚ö†Ô∏è ML Detect√≥ Riesgo" width="3.5" position="0 0.25 0.02" color="#ffaaaa" align="center" font="roboto" shader="msdf"></a-text>
        <a-text value="üî¥ Animal en Peligro" width="3.5" position="0 -0.15 0.02" color="#ffaaaa" align="center" font="roboto" shader="msdf"></a-text>
        <a-text value="üì° Revisar Sensores" width="3.5" position="0 -0.55 0.02" color="#ffaaaa" align="center" font="roboto" shader="msdf"></a-text>
      </a-entity>
      
      <a-entity id="mapaCalor" position="0 -0.49 0">
        <a-circle id="heatCircle" radius="0.5" color="#00ff00" opacity="0.3" position="5 0 -3" rotation="-90 0 0"></a-circle>
        <a-ring radius-inner="0.5" radius-outer="0.7" color="#00ff00" opacity="0.2" position="5 0.01 -3" rotation="-90 0 0"></a-ring>
      </a-entity>
      
      <a-entity id="cameraRig">
        <a-entity 
          camera 
          position="0 1.5 6" 
          look-controls="enabled: true"
          orbit-controls="target: #model-walk; enableDamping: true; dampingFactor: 0.12; rotateSpeed: 0.6; minDistance: 2; maxDistance: 50; enablePan: true; enableZoom: true">
        </a-entity>
      </a-entity>
      
      <a-text 
        value="üñ±Ô∏è Click + Arrastra: Rotar | üé° Rueda del Mouse: Zoom In/Out" 
        width="10" 
        position="0 -1.8 -3" 
        color="#ffffff" 
        align="center"
        font="roboto"
        shader="msdf"
        opacity="0.6">
      </a-text>
    </a-scene>
    
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyAWwZ8N9YCEdTo1rAuVQquqXevIMuGvm8I",
        authDomain: "mbe1-7a7b0.firebaseapp.com",
        projectId: "mbe1-7a7b0",
      };
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      let datosTemperatura = [];
      let indiceActual = 0;
      let intervaloBucle = null;
      const intervaloEntreLecturas = 2000;
      
      let datosSensores = {
        temperatura: null,
        latido: null,
        movimiento: null,
        humedad: null,
        depredador: null,
        riesgo: 0
      };
      
      const animal = document.querySelector("#animal");
      const alertaRing = document.querySelector("#alertaRing");
      const alertaLight = document.querySelector("#alertaLight");
      const alertaText = document.querySelector("#alertaText");
      const panelAlertas = document.querySelector("#panelAlertas");
      const panelAlertasContainer = document.querySelector("#panelAlertasContainer");
      const riesgoText = document.querySelector("#riesgoText");
      const heatCircle = document.querySelector("#heatCircle");
      const tempBar = document.querySelector("#tempBar");
      const latidoBar = document.querySelector("#latidoBar");
      const movimientoBar = document.querySelector("#movimientoBar");
      const humedadBar = document.querySelector("#humedadBar");
      const depredadorText = document.querySelector("#depredadorText");
      const depredadorBar = document.querySelector("#depredadorBar");
      const riesgoBar = document.querySelector("#riesgoBar");
      const bosqueLight = document.querySelector("#bosqueLight");
      const alertaSound = document.querySelector("#alertaSound");

      function obtenerTodosLosDatos() {
        db.collection("sensores")
          .orderBy("timestamp", "asc")
          .get()
          .then((snapshot) => {
            datosTemperatura = [];
            snapshot.forEach((doc) => {
              const data = doc.data();
              datosTemperatura.push({
                valor: data.valor || data.temperatura || "--",
                timestamp: data.timestamp || doc.id,
                id: doc.id
              });
            });
            
            if (datosTemperatura.length > 0) {
              iniciarBucleDatos();
            } else {
              document.querySelector("#sensorText").setAttribute("value", "üå°Ô∏è Temperatura: Sin datos");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            document.querySelector("#sensorText").setAttribute("value", "üå°Ô∏è Error: " + error.message);
          });
      }

      function iniciarBucleDatos() {
        if (intervaloBucle) {
          clearInterval(intervaloBucle);
        }
        
        indiceActual = 0;
        mostrarDatoActual();
        
        intervaloBucle = setInterval(() => {
          indiceActual++;
          if (indiceActual >= datosTemperatura.length) {
            indiceActual = 0;
          }
          mostrarDatoActual();
        }, intervaloEntreLecturas);
      }

      function mostrarDatoActual() {
        if (datosTemperatura.length === 0) return;
        
        const dato = datosTemperatura[indiceActual];
        const temperatura = dato.valor;
        datosSensores.temperatura = temperatura;
        
        let texto = `üå°Ô∏è Temperatura: ${temperatura}¬∞C`;
        let color = "#00ff00";
        const tempNum = parseFloat(temperatura);
        
        if (!isNaN(tempNum)) {
          if (tempNum > 30) color = "#ff0000";
          else if (tempNum > 25) color = "#ffaa00";
          else if (tempNum < 15) color = "#00aaff";
          
          const tempPercent = Math.min(1, Math.max(0, (tempNum - 15) / 20));
          if (tempBar) {
            tempBar.setAttribute("scale", `${tempPercent} 1 1`);
            tempBar.setAttribute("color", color);
          }
        }
        
        const sensorText = document.querySelector("#sensorText");
        sensorText.setAttribute("value", texto);
        sensorText.setAttribute("color", color);
        
        actualizarMapaCalor(temperatura);
      }
      
      function actualizarMapaCalor(temperatura) {
        if (!heatCircle) return;
        
        const tempNum = parseFloat(temperatura);
        if (isNaN(tempNum)) return;
        
        let color = "#00ff00";
        let opacity = 0.3;
        let radius = 0.5;
        
        if (tempNum > 30) {
          color = "#ff0000";
          opacity = 0.6;
          radius = 1.2;
        } else if (tempNum > 25) {
          color = "#ffaa00";
          opacity = 0.5;
          radius = 0.9;
        } else if (tempNum < 15) {
          color = "#00aaff";
          opacity = 0.4;
          radius = 0.7;
        }
        
        heatCircle.setAttribute("color", color);
        heatCircle.setAttribute("opacity", opacity);
        heatCircle.setAttribute("radius", radius);
        
        if (bosqueLight) {
          if (tempNum > 30 || datosSensores.riesgo === 1) {
            bosqueLight.setAttribute("color", "#ff4444");
            bosqueLight.setAttribute("intensity", "1.5");
          } else if (tempNum > 25) {
            bosqueLight.setAttribute("color", "#ffaa44");
            bosqueLight.setAttribute("intensity", "1.2");
          } else {
            bosqueLight.setAttribute("color", "#88ff88");
            bosqueLight.setAttribute("intensity", "1");
          }
        }
      }
      
      function actualizarColorAnimal(riesgo) {
        if (!animal) return;
        
        datosSensores.riesgo = riesgo;
        
        if (riesgo === 1 || riesgo === "1") {
          animal.setAttribute("material", "color: #ff6b6b; emissive: #ff0000; emissiveIntensity: 0.3; metalness: 0.3; roughness: 0.7");
        } else {
          animal.setAttribute("material", "color: #8B7355; emissive: #000000; emissiveIntensity: 0; metalness: 0.3; roughness: 0.7");
        }
      }
      
      function activarAlerta(activo) {
        if (activo) {
          alertaRing.setAttribute("visible", "true");
          alertaRing.setAttribute("opacity", "0.6");
          alertaLight.setAttribute("intensity", "2");
          alertaText.setAttribute("visible", "true");
          panelAlertas.setAttribute("visible", "true");
          panelAlertas.setAttribute("opacity", "0.95");
          panelAlertasContainer.setAttribute("visible", "true");
          alertaRing.setAttribute("animation", "property: scale; to: 1.5 1.5 1.5; loop: true; dur: 1000; easing: easeInOutSine; dir: alternate");
          riesgoText.setAttribute("value", "‚ö†Ô∏è Riesgo: ALTO");
          riesgoText.setAttribute("color", "#ff0000");
          if (riesgoBar) {
            riesgoBar.setAttribute("scale", "1 1 1");
            riesgoBar.setAttribute("color", "#ff0000");
          }
          if (alertaSound) {
            alertaSound.components.sound.playSound();
          }
        } else {
          alertaRing.setAttribute("visible", "false");
          alertaRing.setAttribute("opacity", "0");
          alertaLight.setAttribute("intensity", "0");
          alertaText.setAttribute("visible", "false");
          panelAlertas.setAttribute("visible", "false");
          panelAlertas.setAttribute("opacity", "0");
          panelAlertasContainer.setAttribute("visible", "false");
          riesgoText.setAttribute("value", "‚ö†Ô∏è Riesgo: Normal");
          riesgoText.setAttribute("color", "#95e1d3");
          if (riesgoBar) {
            riesgoBar.setAttribute("scale", "0 1 1");
            riesgoBar.setAttribute("color", "#95e1d3");
          }
          if (alertaSound) {
            alertaSound.components.sound.stopSound();
          }
        }
      }
      
      function actualizarSensores(data) {
        if (data.latido !== undefined && data.latido !== null) {
          datosSensores.latido = data.latido;
          const latidoText = document.querySelector("#latidoText");
          if (latidoText) {
            latidoText.setAttribute("value", `üíì Latido: ${data.latido} bpm`);
          }
          if (latidoBar) {
            const latidoPercent = Math.min(1, Math.max(0, (data.latido - 60) / 60));
            latidoBar.setAttribute("scale", `${latidoPercent} 1 1`);
          }
        } else {
          const latidoText = document.querySelector("#latidoText");
          if (latidoText && !datosSensores.latido) {
            latidoText.setAttribute("value", "üíì Latido: -- bpm");
          }
        }
        
        if (data.movimiento !== undefined && data.movimiento !== null) {
          datosSensores.movimiento = data.movimiento;
          const movimientoText = document.querySelector("#movimientoText");
          if (movimientoText) {
            const movimientoStr = data.movimiento === 1 || data.movimiento === "1" ? "Activo" : "Inactivo";
            movimientoText.setAttribute("value", `üèÉ Movimiento: ${movimientoStr}`);
          }
          if (movimientoBar) {
            const movimientoPercent = data.movimiento === 1 || data.movimiento === "1" ? 1 : 0;
            movimientoBar.setAttribute("scale", `${movimientoPercent} 1 1`);
          }
        } else {
          const movimientoText = document.querySelector("#movimientoText");
          if (movimientoText && datosSensores.movimiento === null) {
            movimientoText.setAttribute("value", "üèÉ Movimiento: --");
          }
        }
        
        if (data.humedad !== undefined && data.humedad !== null) {
          datosSensores.humedad = data.humedad;
          const humedadText = document.querySelector("#humedadText");
          if (humedadText) {
            humedadText.setAttribute("value", `üíß Humedad: ${data.humedad}%`);
          }
          if (humedadBar) {
            const humedadPercent = data.humedad / 100;
            humedadBar.setAttribute("scale", `${humedadPercent} 1 1`);
          }
        } else {
          const humedadText = document.querySelector("#humedadText");
          if (humedadText && !datosSensores.humedad) {
            humedadText.setAttribute("value", "üíß Humedad: --%");
          }
        }
        
        if (data.depredador !== undefined && data.depredador !== null) {
          datosSensores.depredador = data.depredador;
          const depredadorText = document.querySelector("#depredadorText");
          if (depredadorText) {
            const depredadorStr = data.depredador === 1 || data.depredador === "1" ? "S√≠ Detectado" : "No";
            depredadorText.setAttribute("value", `ü¶Å Depredador: ${depredadorStr}`);
            depredadorText.setAttribute("color", data.depredador === 1 || data.depredador === "1" ? "#ff4444" : "#ff9800");
          }
          if (depredadorBar) {
            const depredadorPercent = data.depredador === 1 || data.depredador === "1" ? 1 : 0;
            depredadorBar.setAttribute("scale", `${depredadorPercent} 1 1`);
            depredadorBar.setAttribute("color", data.depredador === 1 || data.depredador === "1" ? "#ff4444" : "#ff9800");
          }
        } else {
          const depredadorText = document.querySelector("#depredadorText");
          if (depredadorText && datosSensores.depredador === null) {
            depredadorText.setAttribute("value", "ü¶Å Depredador: --");
          }
        }
      }

      db.collection("sensores")
        .orderBy("timestamp", "desc")
        .limit(1)
        .onSnapshot((snapshot) => {
          snapshot.forEach((doc) => {
            const data = doc.data();
            const nuevoDato = {
              valor: data.valor || data.temperatura || "--",
              timestamp: data.timestamp || doc.id,
              id: doc.id
            };
            
            let latido = null;
            let movimiento = null;
            let humedad = null;
            let depredador = null;
            
            if (data.latido) {
              latido = typeof data.latido === 'object' ? data.latido.integerValue || data.latido.stringValue : data.latido;
            }
            if (data.movimiento !== undefined) {
              movimiento = typeof data.movimiento === 'object' ? data.movimiento.integerValue || data.movimiento.stringValue : data.movimiento;
            }
            if (data.humedad) {
              humedad = typeof data.humedad === 'object' ? data.humedad.integerValue || data.humedad.stringValue : data.humedad;
            }
            if (data.depredador !== undefined) {
              depredador = typeof data.depredador === 'object' ? data.depredador.integerValue || data.depredador.stringValue : data.depredador;
            }
            
            actualizarSensores({
              latido: latido || datosSensores.latido,
              movimiento: movimiento !== null ? movimiento : datosSensores.movimiento,
              humedad: humedad || datosSensores.humedad,
              depredador: depredador !== null ? depredador : datosSensores.depredador
            });
            
            const existe = datosTemperatura.some(d => d.id === nuevoDato.id);
            if (!existe) {
              datosTemperatura.push(nuevoDato);
              datosTemperatura.sort((a, b) => {
                if (a.timestamp < b.timestamp) return -1;
                if (a.timestamp > b.timestamp) return 1;
                return 0;
              });
            }
          });
        });
      
      db.collection("alertas")
        .orderBy("timestamp", "desc")
        .limit(1)
        .onSnapshot((snapshot) => {
          snapshot.forEach((doc) => {
            const data = doc.data();
            const riesgo = data.riesgo || data.prediccion || 0;
            actualizarColorAnimal(riesgo);
            activarAlerta(riesgo === 1);
          });
        });
      
      db.collection("comportamientos")
        .orderBy("timestamp", "desc")
        .limit(1)
        .onSnapshot((snapshot) => {
          snapshot.forEach((doc) => {
            const data = doc.data();
          });
        });

      window.addEventListener("load", () => {
        setTimeout(() => {
          obtenerTodosLosDatos();
          setInterval(obtenerTodosLosDatos, 30000);
        }, 1000);
      });
    </script>
  </body>
</html>
